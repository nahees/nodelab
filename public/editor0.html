<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title></title>
<link rel="stylesheet" href="basic.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css">
<style>
canvas {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
}

.CodeMirror {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
  z-index: 10;
  background-color: rgba(255, 255, 255, 0.5);
}

</style>
</head>
<body>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/esprima/2.7.3/esprima.min.js"></script>
<script>
// somewhat adapted from https://mrdoob.com/projects/htmleditor/
let renderer, scene, camera;
let setup, draw;

function reset() {
  camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    10
  );
  camera.position.z = 3;

  clearScene();

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);
}

function clearScene() {
  // this may be naive, see discussion at
  // https://stackoverflow.com/questions/30359830/how-do-i-clear-three-js-scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xffffff);
}

function animate(time) {
  //console.log(draw);
  if (draw) draw(time);

  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

let code = `// global: camera, renderer, scene
clearScene(); // if you want to

let geometry = new THREE.SphereGeometry(1);
let material = new THREE.MeshBasicMaterial({ color: 0x000000, wireframe: true });
let mesh = new THREE.Mesh(geometry, material);
scene.add(mesh);

draw = function (time) {
  mesh.rotation.x = time * 0.0005;
  mesh.rotation.y = time * 0.001;
}
`;

let interval;
//https://cdnjs.com/libraries/codemirror
let codemirror = CodeMirror(document.body, {
  value: code,
  mode: "javascript",
  lineNumbers: true,
  matchBrackets: true,
  indentWithTabs: true,
  tabSize: 4,
  indentUnit: 4
});

codemirror.on("change", function () {
  clearTimeout(interval);
  interval = setTimeout(update, 250);
});

function validate(code) {
  try {
    let result = esprima.parse(code, { tolerant: true }).errors;
    if (result.length === 0) return true;
    console.log(result);
  } catch (e) {
    console.error(e.message);
  }
}

function update() {
  let code = codemirror.getValue();
  if (!validate(code)) return;
  // yeah I know, we shouldn't be using eval
  // we should be using new Function or module or something safer via esprima etc.
  eval(code);
}

reset();
update();

</script>
</html>