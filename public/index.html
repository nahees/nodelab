<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title></title>
<link rel="stylesheet" href="basic.css">
<style>
#status {
	text-transform: uppercase;
	background-color: rgba(0, 0, 0, 0.2);
	/*font-size: 1.4rem;*/
	text-rendering: optimizeLegibility;
	font-family: monospace;
}
#log {
	white-space: pre;
	text-rendering: optimizeLegibility;
	font-family: monospace;
}
</style>
</head>
<body>
<div id="status">No status</div>
<div id="log"></div>
<script>
const HOST = location.origin.replace(/^http/, 'ws');
let server;

// let ws = new WebSocket(HOST);
// ws.onmessage = function (event) {
// 	document.getElementById('status').innerText = event.data;
// };

let connection_div = document.getElementById("status")
let serverMessage = function (msg) {
	console.log("received", msg)
	document.getElementById("log").innerText += msg + "\n"
}

function connect() {
	if (server) return;

	server = new WebSocket(HOST);
	connection_div.innerText = `connecting to ${HOST}`
	server.binaryType = "arraybuffer";

	reconnect = function() {
		connection_div.innerText = ("connection lost")
		//setTimeout(connect, reconnect_timeout)
	}

	server.onerror = function(event, err) {
		connection_div.innerText = `connection error ${event} ${server.readyState}`
		console.error("WebSocket error observed:", event, server.readyState);
		socket = null
		reconnect();
	}

	server.onopen = () => {
		connection_div.innerText = `connected to ${HOST}`

		server.onclose = function(event) {
			console.log("WebSocket is closed now.");
			connection_div.innerText = "disconnected"
			server = null
			reconnect();
		}

		//socket.send('Here\'s some text that the server is urgently awaiting!'); 
		server.onmessage = event => {
			if (serverMessage) serverMessage(event.data)
			// if (serverMessage) {
			// 	if (event.data[0]=="{") {
			// 		serverMessage(JSON.parse(event.data), server)
			// 	} else {
			// 		console.log(`Received message ${event.data}`);
			// 	}
			// }
// 			//if(event.data instanceof ArrayBuffer) {
// 			let msg = JSON.parse(event.data)
// 			if (msg.cmd == "setcode") {
// 				//console.log("setcode", msg.code)

// 				editor.setValue(msg.code)
// 				editor_dirty = false;
// 			} else if (msg.cmd == "setstate") {
// 				data.innerText = JSON.stringify(msg.state, null, "  ")
// 			} else {
// 				console.log(`Received message ${msg}`);
// 			}
		}

		// request current code:
		server.send(`{"cmd":"getcode"}`)
	}
}
connect();

</script>
</body>
</html>